<mxfile host="app.diagrams.net" modified="2024-01-01T00:00:00.000Z" agent="Claude" version="22.1.0" type="device">
  <diagram name="Backend Sequence Diagram" id="sequence-diagram">
    <mxGraphModel dx="1434" dy="780" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1800" pageHeight="2400" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="The Frustrating Registration Form - Backend Sequence Diagram" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1;fontColor=#232F3E;" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="700" height="40" as="geometry" />
        </mxCell>

        <!-- Actors/Participants -->
        <!-- User -->
        <mxCell id="user-box" value="User&#xa;(Browser)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="80" y="80" width="100" height="50" as="geometry" />
        </mxCell>
        <mxCell id="user-line" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#6c8ebf;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="130" y="130" as="sourcePoint" />
            <mxPoint x="130" y="2300" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- CloudFront -->
        <mxCell id="cf-box" value="CloudFront" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="280" y="80" width="100" height="50" as="geometry" />
        </mxCell>
        <mxCell id="cf-line" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#d6b656;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="330" y="130" as="sourcePoint" />
            <mxPoint x="330" y="2300" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- ALB -->
        <mxCell id="alb-box" value="ALB" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="480" y="80" width="100" height="50" as="geometry" />
        </mxCell>
        <mxCell id="alb-line" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#d79b00;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="530" y="130" as="sourcePoint" />
            <mxPoint x="530" y="2300" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Backend -->
        <mxCell id="backend-box" value="Backend&#xa;(ECS Fargate)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="680" y="80" width="100" height="50" as="geometry" />
        </mxCell>
        <mxCell id="backend-line" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="730" y="130" as="sourcePoint" />
            <mxPoint x="730" y="2300" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- S3 -->
        <mxCell id="s3-box" value="S3&#xa;(Assets)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="880" y="80" width="100" height="50" as="geometry" />
        </mxCell>
        <mxCell id="s3-line" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#9673a6;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="930" y="130" as="sourcePoint" />
            <mxPoint x="930" y="2300" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Bedrock -->
        <mxCell id="bedrock-box" value="Bedrock&#xa;(Claude 3 Haiku)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="1080" y="80" width="120" height="50" as="geometry" />
        </mxCell>
        <mxCell id="bedrock-line" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#b85450;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1140" y="130" as="sourcePoint" />
            <mxPoint x="1140" y="2300" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- ========== PHASE 1: Waiting Queue ========== -->
        <mxCell id="phase1-label" value="Phase 1: 待機列 (WebSocket)" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="160" width="250" height="30" as="geometry" />
        </mxCell>

        <!-- WS Connect -->
        <mxCell id="ws1" value="GET /ws (WebSocket Upgrade)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="130" y="220" as="sourcePoint" />
            <mxPoint x="330" y="220" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ws2" value="" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="330" y="240" as="sourcePoint" />
            <mxPoint x="530" y="240" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ws3" value="" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="530" y="260" as="sourcePoint" />
            <mxPoint x="730" y="260" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Backend processing -->
        <mxCell id="backend-act1" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#82b366;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="725" y="270" width="10" height="80" as="geometry" />
        </mxCell>
        <mxCell id="note1" value="- Session ID発行 (Cookie)&#xa;- User構造体作成&#xa;- WaitingQueueに追加&#xa;- status: &quot;waiting&quot;" style="text;html=1;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="750" y="270" width="180" height="70" as="geometry" />
        </mxCell>

        <!-- WS Response -->
        <mxCell id="ws4" value="101 Switching Protocols + Set-Cookie" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="370" as="sourcePoint" />
            <mxPoint x="130" y="370" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Queue updates -->
        <mxCell id="ws5" value="{type: &quot;queue_update&quot;, position: 5}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#6c8ebf;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="410" as="sourcePoint" />
            <mxPoint x="130" y="410" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="note2" value="順番待ち...&#xa;(10-30秒の焦らし時間)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="350" y="430" width="150" height="40" as="geometry" />
        </mxCell>

        <!-- Stage change -->
        <mxCell id="ws6" value="{type: &quot;stage_change&quot;, status: &quot;stage1_dino&quot;}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#82b366;fontStyle=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="490" as="sourcePoint" />
            <mxPoint x="130" y="490" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- ========== PHASE 2: Dino Run ========== -->
        <mxCell id="phase2-label" value="Phase 2: Dino Run (第1関門)" style="text;html=1;strokeColor=#d79b00;fillColor=#ffe6cc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="530" width="250" height="30" as="geometry" />
        </mxCell>

        <mxCell id="note3" value="ゲームプレイ中...&#xa;(タイムアウト: 3分)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="570" width="150" height="40" as="geometry" />
        </mxCell>

        <!-- Dino result -->
        <mxCell id="dino1" value="POST /api/game/dino/result {score: 500, survived: true}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="130" y="630" as="sourcePoint" />
            <mxPoint x="330" y="630" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="dino2" value="" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="330" y="650" as="sourcePoint" />
            <mxPoint x="530" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="dino3" value="" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="530" y="670" as="sourcePoint" />
            <mxPoint x="730" y="670" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="backend-act2" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#82b366;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="725" y="680" width="10" height="50" as="geometry" />
        </mxCell>
        <mxCell id="note4" value="status: &quot;stage2_captcha&quot;に更新" style="text;html=1;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="750" y="685" width="180" height="40" as="geometry" />
        </mxCell>

        <mxCell id="dino4" value="{error: false, next_stage: &quot;captcha&quot;}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#82b366;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="750" as="sourcePoint" />
            <mxPoint x="130" y="750" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- ========== PHASE 3: CAPTCHA ========== -->
        <mxCell id="phase3-label" value="Phase 3: CAPTCHA (第2関門)" style="text;html=1;strokeColor=#9673a6;fillColor=#e1d5e7;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="790" width="250" height="30" as="geometry" />
        </mxCell>

        <!-- CAPTCHA Generate -->
        <mxCell id="cap1" value="GET /api/captcha/generate" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="130" y="850" as="sourcePoint" />
            <mxPoint x="730" y="850" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="backend-act3" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#82b366;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="725" y="860" width="10" height="80" as="geometry" />
        </mxCell>

        <!-- S3 call -->
        <mxCell id="s3-1" value="背景画像取得" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#9673a6;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="735" y="880" as="sourcePoint" />
            <mxPoint x="930" y="880" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s3-2" value="画像データ" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#9673a6;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="930" y="900" as="sourcePoint" />
            <mxPoint x="735" y="900" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="note5" value="- 背景 + 極小キャラクター合成&#xa;- 正解座標をUserに保存&#xa;- CaptchaAttempts = 0" style="text;html=1;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="750" y="910" width="180" height="50" as="geometry" />
        </mxCell>

        <mxCell id="cap2" value="{image_url: &quot;https://...captcha.png&quot;}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#82b366;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="980" as="sourcePoint" />
            <mxPoint x="130" y="980" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- CAPTCHA Verify -->
        <mxCell id="cap3" value="POST /api/captcha/verify {x: 123, y: 456}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="130" y="1020" as="sourcePoint" />
            <mxPoint x="730" y="1020" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="backend-act4" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#82b366;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="725" y="1030" width="10" height="60" as="geometry" />
        </mxCell>
        <mxCell id="note6" value="- 座標判定 (許容: 半径5-10px)&#xa;- status: &quot;registering&quot;&#xa;- RegisterToken発行 (10分)" style="text;html=1;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="750" y="1030" width="180" height="50" as="geometry" />
        </mxCell>

        <mxCell id="cap4" value="{error: false, token: &quot;550e8400-...&quot;}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#82b366;fontStyle=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="1110" as="sourcePoint" />
            <mxPoint x="130" y="1110" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- ========== PHASE 4: Registration ========== -->
        <mxCell id="phase4-label" value="Phase 4: 会員登録 (The Final Boss)" style="text;html=1;strokeColor=#b85450;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="1150" width="250" height="30" as="geometry" />
        </mxCell>

        <!-- Password Analysis -->
        <mxCell id="pwd1" value="POST /api/password/analyze {password: &quot;taro1998&quot;}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="130" y="1210" as="sourcePoint" />
            <mxPoint x="730" y="1210" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="backend-act5" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#82b366;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="725" y="1220" width="10" height="80" as="geometry" />
        </mxCell>

        <!-- Bedrock call -->
        <mxCell id="br1" value="InvokeModel (パスワード分析)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#b85450;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="735" y="1240" as="sourcePoint" />
            <mxPoint x="1140" y="1240" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="br2" value="煽りメッセージ生成" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#b85450;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1140" y="1270" as="sourcePoint" />
            <mxPoint x="735" y="1270" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="pwd2" value="{message: &quot;太郎さん？1998年生まれ？そのパスワード3秒で破られますよ...&quot;}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#b85450;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="1320" as="sourcePoint" />
            <mxPoint x="130" y="1320" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Fish OTP -->
        <mxCell id="otp-label" value="魚OTP認証" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=3;" vertex="1" parent="1">
          <mxGeometry x="40" y="1350" width="100" height="20" as="geometry" />
        </mxCell>

        <mxCell id="otp1" value="POST /api/otp/send" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="130" y="1390" as="sourcePoint" />
            <mxPoint x="730" y="1390" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="backend-act6" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#82b366;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="725" y="1400" width="10" height="60" as="geometry" />
        </mxCell>

        <mxCell id="s3-3" value="魚画像取得 (ランダム)" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#9673a6;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="735" y="1420" as="sourcePoint" />
            <mxPoint x="930" y="1420" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="s3-4" value="onikamasu.jpg" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#9673a6;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="930" y="1440" as="sourcePoint" />
            <mxPoint x="735" y="1440" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="otp2" value="{image_url: &quot;.../onikamasu.jpg&quot;, message: &quot;この魚の名前を入力&quot;}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#82b366;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="1490" as="sourcePoint" />
            <mxPoint x="130" y="1490" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="otp3" value="POST /api/otp/verify {answer: &quot;オニカマス&quot;}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="130" y="1530" as="sourcePoint" />
            <mxPoint x="730" y="1530" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="backend-act7" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#82b366;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="725" y="1540" width="10" height="40" as="geometry" />
        </mxCell>
        <mxCell id="note7" value="ひらがな/カタカナ許容で判定" style="text;html=1;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="750" y="1545" width="170" height="30" as="geometry" />
        </mxCell>

        <mxCell id="otp4" value="{error: false, message: &quot;正解！&quot;}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#82b366;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="1600" as="sourcePoint" />
            <mxPoint x="130" y="1600" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Final Registration -->
        <mxCell id="reg-label" value="登録完了 (鬼畜仕様)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=3;fontColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="40" y="1630" width="150" height="20" as="geometry" />
        </mxCell>

        <mxCell id="reg1" value="POST /api/register {token, name, email, password, ...}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;strokeColor=#232F3E;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="130" y="1680" as="sourcePoint" />
            <mxPoint x="730" y="1680" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="backend-act8" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#b85450;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="725" y="1690" width="10" height="60" as="geometry" />
        </mxCell>
        <mxCell id="note8" value="バリデーション成功...&#xa;しかし！" style="text;html=1;strokeColor=#b85450;fillColor=#f8cecc;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="750" y="1695" width="130" height="40" as="geometry" />
        </mxCell>

        <!-- The Final Blow -->
        <mxCell id="final-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;strokeWidth=3;" vertex="1" parent="1">
          <mxGeometry x="100" y="1770" width="1120" height="120" as="geometry" />
        </mxCell>

        <mxCell id="reg2" value="{error: true, message: &quot;サーバーエラーが発生しました。最初からやり直してください。&quot;, redirect_delay: 3}" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#b85450;strokeWidth=2;fontStyle=1;fontColor=#b85450;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="1810" as="sourcePoint" />
            <mxPoint x="130" y="1810" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="ws-close" value="WebSocket切断" style="html=1;verticalAlign=bottom;endArrow=block;rounded=0;dashed=1;strokeColor=#b85450;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="730" y="1850" as="sourcePoint" />
            <mxPoint x="130" y="1850" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="final-note" value="永遠に登録は完了しない" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1;fontColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="400" y="1860" width="250" height="30" as="geometry" />
        </mxCell>

        <!-- Redirect -->
        <mxCell id="redirect" value="3秒後にトップページへリダイレクト" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=12;fontStyle=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="1920" width="220" height="30" as="geometry" />
        </mxCell>

        <!-- Loop back arrow -->
        <mxCell id="loop" value="" style="endArrow=block;html=1;rounded=1;strokeColor=#6c8ebf;strokeWidth=2;exitX=0;exitY=0.5;exitDx=0;exitDy=0;curved=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="40" y="1935" as="sourcePoint" />
            <mxPoint x="40" y="220" as="targetPoint" />
            <Array as="points">
              <mxPoint x="10" y="1935" />
              <mxPoint x="10" y="220" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="loop-label" value="待機列の最後尾へ" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11;fontStyle=2;rotation=-90;" vertex="1" parent="1">
          <mxGeometry x="-50" y="1050" width="120" height="20" as="geometry" />
        </mxCell>

        <!-- ========== FAILURE ALT BOX ========== -->
        <mxCell id="alt-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#d79b00;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="1250" y="500" width="300" height="400" as="geometry" />
        </mxCell>
        <mxCell id="alt-title" value="失敗パターン (どの段階でも)" style="text;html=1;strokeColor=#d79b00;fillColor=#ffe6cc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=12;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1270" y="510" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="alt-content" value="■ Dino Run失敗&#xa;  - survived: false&#xa;  - タイムアウト (3分)&#xa;&#xa;■ CAPTCHA失敗&#xa;  - 3回不正解&#xa;  - タイムアウト (3分)&#xa;&#xa;■ 魚OTP失敗&#xa;  - 3回不正解&#xa;&#xa;■ トークン期限切れ&#xa;  - 10分経過&#xa;&#xa;↓ すべて同じ結果 ↓&#xa;&#xa;{error: true,&#xa; message: &quot;失敗...&quot;,&#xa; redirect_delay: 3}&#xa;&#xa;→ WebSocket切断&#xa;→ 3秒後リダイレクト&#xa;→ 待機列の最後尾へ" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;spacing=5;" vertex="1" parent="1">
          <mxGeometry x="1260" y="550" width="280" height="340" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
